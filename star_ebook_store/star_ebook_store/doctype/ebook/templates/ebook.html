{% extends "templates/store/base.html" %}

{% block head_script_tags %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
{% endblock %}

{% block body %}
<main class="container mb-6">
    <nav class="breadcrumb mt-4" aria-label="breadcrumbs">
        <ul>
            <li><a href="/store">Store</a></li>
            <li class="is-active"><a href="#" aria-current="page">{{ doc.name }}</a></li>
        </ul>
    </nav>

    <div class="columns">
        <div class="column is-one-third">
            <img class="cover-image px-6" src="{{ doc.cover_image }}" alt="Book Cover Image">
        </div>
        <div class="column">
            <div>
                <h1 class="title is-1">{{ doc.name }}</h1>
                <h2 class="subtitle is-4">by {{ author.name }}</h2>
            </div>

            <div class="mt-3">
                <span class="tag is-link is-normal">{{ doc.format }}</span>
            </div>

            <div>
                <button id="buy-button" class="button is-medium is-outlined is-link mt-5">Buy</button>
            </div>
        </div>
    </div>
</main>

<section class="container">
    <div class="tabs">
        <ul>
            <li class="is-active"><a>Description</a></li>
            <li><a>TOC</a></li>
            <li><a>About the author</a></li>
        </ul>
    </div>

    <div>
        <p>{{ frappe.utils.md_to_html(doc.description) }}</p>
    </div>

    <div>
        <p>{{ frappe.utils.md_to_html(doc.toc) }}</p>
    </div>

    <div>
        <p>{{ frappe.utils.md_to_html(author.bio) }}</p>
    </div>
</section>

<script>
    const buyButton = document.getElementById("buy-button");

    buyButton.onclick = async function (e) {
        const headers = {
            Accept: 'application/json',
            'Content-Type': 'application/json; charset=utf-8',
            'X-Frappe-CSRF-Token': '{{ csrf_token }}'
        }

        const response = await fetch("/api/method/star_ebook_store.api.create_ebook_order", {
            method: 'POST',
            body: JSON.stringify({
                ebook_name: '{{ doc.name }}',
                customer_email: 'hello@apple.com'
            }),
            headers
        })

        if (response.ok) {
            const orderData = (await response.json()).message // frappe wraps the response inside "message" key

            const options = {
                "key": orderData.key_id,
                "order_id": orderData.order_id,
                "handler": (res) => {
                    alert("Payment Success! Your eBook is on the way!")
                }
            }

            const razorpayOrder = createRazorpayOrder(options);
            razorpayOrder.open();
        } else {
            alert("Something went wrong");
            // EXERCISE: Better handling 
        }

        e.preventDefault()
    }

    function createRazorpayOrder(options) {
        const razorpayOrder = new Razorpay(options)
        return razorpayOrder
    }
</script>

{% endblock %}